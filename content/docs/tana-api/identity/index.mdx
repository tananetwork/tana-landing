---
title: /auth (Identity Service)
description: Mobile-first authentication and session management API
---

The Identity Service provides secure authentication for Tana applications using mobile-first QR code authentication (similar to WhatsApp Web). Private keys remain exclusively on mobile devices, while desktop/laptop computers receive session tokens only.

**Base URL:** `http://localhost:8090` (development) or `https://auth.tana.network` (production)

**Key Concepts:**
- **Session-based authentication** - No private keys on desktop/laptop
- **QR code login** - Mobile app scans QR from website
- **Server-Sent Events (SSE)** - Real-time session status updates
- **Ed25519 signatures** - Cryptographic proof of ownership
- **Hardware security** - Private keys protected by mobile device secure enclave

---

## Authentication Flow

```
1. Website → POST /auth/session/create
   Returns: sessionId, challenge, QR data

2. Website → GET /auth/session/:id/events (SSE)
   Streams: Real-time session status updates

3. Mobile App → GET /auth/session/:id
   Returns: Session details, marks as "scanned"

4. User approves on mobile

5. Mobile App → POST /auth/session/:id/approve
   Body: Signed challenge with Ed25519

6. SSE → "approved" event to website
   Includes: sessionToken for authenticated requests

7. Website uses sessionToken for subsequent API calls
```

---

<details>
 <summary><code className="text-green-400">POST</code> <code><b>/auth/session/create</b></code> <code>(create QR login session)</code></summary>

### Request

```bash
curl -X POST http://localhost:8090/auth/session/create \
  -H "Content-Type: application/json" \
  -d '{
    "returnUrl": "http://localhost:3000/dashboard",
    "appName": "My Tana App",
    "appIcon": "https://example.com/icon.png"
  }'
```

### Parameters

<table>
 <tr>
    <td>_parameter_</td>
    <td>_type_</td>
    <td>_necessity_</td>
  </tr>
 <tr>
    <td>**returnUrl**</td>
    <td>string (URL)</td>
    <td>required</td>
  </tr>
 <tr>
    <td>**appName**</td>
    <td>string</td>
    <td>optional</td>
  </tr>
 <tr>
    <td>**appIcon**</td>
    <td>string (URL)</td>
    <td>optional</td>
  </tr>
</table>

### Response

```json
{
  "sessionId": "sess_3ogy2lnxi0fl4rlz",
  "challenge": "auth_chal_b92f3aed...",
  "expiresAt": 1762915859863,
  "expiresIn": 300,
  "qrData": "{\"sessionId\":\"sess_...\",\"challenge\":\"auth_chal_...\",\"service\":\"tana-identity\"}"
}
```

**Status:** `201 Created`

**Use Case:** Website initiates login flow by creating a session and displaying QR code

</details>

---

<details>
 <summary><code className="text-cyan-400">GET</code> <code><b>/auth/session/:id/events</b></code> <code>(SSE stream for real-time updates)</code></summary>

### Request

```bash
curl -N http://localhost:8090/auth/session/sess_abc123/events
```

### Server-Sent Events

**Connection event:**
```json
event: connected
data: {"type":"connected","sessionId":"sess_abc123"}
```

**Status update event:**
```json
event: status
data: {"type":"status","status":"waiting","scannedAt":null,"approvedAt":null}
```

**Scanned event:**
```json
event: status
data: {"type":"status","status":"scanned","scannedAt":"2025-01-11T19:00:00.000Z","approvedAt":null}
```

**Approved event (terminal):**
```json
event: approved
data: {
  "type":"approved",
  "sessionToken":"tana_session_abc123...",
  "userId":"usr_alice",
  "username":"@alice",
  "returnUrl":"http://localhost:3000/dashboard"
}
```

**Rejected event (terminal):**
```json
event: rejected
data: {"type":"rejected"}
```

**Expired event (terminal):**
```json
event: expired
data: {"type":"expired"}
```

**Status:** `200 OK` (keeps connection open)

**Use Case:** Website opens SSE connection to receive real-time status updates as user scans/approves on mobile

</details>

---

<details>
 <summary><code className="text-cyan-400">GET</code> <code><b>/auth/session/:id</b></code> <code>(get session details)</code></summary>

### Request

```bash
curl http://localhost:8090/auth/session/sess_abc123
```

### Response

```json
{
  "sessionId": "sess_abc123",
  "challenge": "auth_chal_b92f3aed...",
  "status": "waiting",
  "appName": "My Tana App",
  "appIcon": "https://example.com/icon.png",
  "expiresAt": 1762915859863
}
```

**Status:** `200 OK`

**Side Effect:** If session status is "waiting", automatically marks as "scanned"

**Use Case:** Mobile app scans QR code and retrieves session details

</details>

---

<details>
 <summary><code className="text-green-400">POST</code> <code><b>/auth/session/:id/approve</b></code> <code>(approve login with signature)</code></summary>

### Request

```bash
curl -X POST http://localhost:8090/auth/session/sess_abc123/approve \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "usr_alice",
    "username": "@alice",
    "publicKey": "ed25519_abc123...",
    "signature": "0x1a2b3c...",
    "message": "I approve this login session: auth_chal_b92f3aed..."
  }'
```

### Parameters

<table>
 <tr>
    <td>_parameter_</td>
    <td>_type_</td>
    <td>_necessity_</td>
  </tr>
 <tr>
    <td>**userId**</td>
    <td>string (UUID)</td>
    <td>required</td>
  </tr>
 <tr>
    <td>**username**</td>
    <td>string</td>
    <td>required</td>
  </tr>
 <tr>
    <td>**publicKey**</td>
    <td>string</td>
    <td>required</td>
  </tr>
 <tr>
    <td>**signature**</td>
    <td>string (hex)</td>
    <td>required</td>
  </tr>
 <tr>
    <td>**message**</td>
    <td>string</td>
    <td>required</td>
  </tr>
</table>

### Response

```json
{
  "success": true,
  "sessionToken": "tana_session_abc123...",
  "returnUrl": "http://localhost:3000/dashboard"
}
```

**Status:** `200 OK`

**Validation:**
- Ed25519 signature must be valid for the provided message and public key
- Message must contain the session challenge
- Session must be in "waiting" or "scanned" state
- Session must not be expired

**Use Case:** User approves login on mobile app, which signs the challenge with private key

</details>

---

<details>
 <summary><code className="text-green-400">POST</code> <code><b>/auth/session/:id/reject</b></code> <code>(reject login)</code></summary>

### Request

```bash
curl -X POST http://localhost:8090/auth/session/sess_abc123/reject
```

### Response

```json
{
  "success": true
}
```

**Status:** `200 OK`

**Use Case:** User rejects login attempt on mobile app

</details>

---

<details>
 <summary><code className="text-green-400">POST</code> <code><b>/auth/session/validate</b></code> <code>(validate session token)</code></summary>

### Request

```bash
curl -X POST http://localhost:8090/auth/session/validate \
  -H "Content-Type: application/json" \
  -d '{
    "sessionToken": "tana_session_abc123..."
  }'
```

### Parameters

<table>
 <tr>
    <td>_parameter_</td>
    <td>_type_</td>
    <td>_necessity_</td>
  </tr>
 <tr>
    <td>**sessionToken**</td>
    <td>string</td>
    <td>required</td>
  </tr>
</table>

### Response (Valid)

```json
{
  "valid": true,
  "userId": "usr_alice",
  "username": "@alice"
}
```

**Status:** `200 OK`

### Response (Invalid)

```json
{
  "error": "Invalid or expired session token"
}
```

**Status:** `401 Unauthorized`

**Use Case:** Backend services validate session tokens from authenticated requests

</details>

---

## Security Model

### Private Key Isolation

**✅ SECURE (Mobile Device):**
- Private keys stored in hardware-backed secure enclave (iOS) / StrongBox (Android)
- Biometric protection (Face ID, Touch ID, fingerprint)
- OS-level sandboxing prevents key extraction
- Signatures generated within secure hardware

**❌ INSECURE (Desktop/Laptop):**
- No private keys - only session tokens
- Session tokens are revocable and time-limited (30 days)
- Tokens provide read-only blockchain access
- Desktop computers more vulnerable to malware

### Why No Browser Extensions?

Tana explicitly rejects the MetaMask/browser extension model:

1. **Malware Risk** - Desktop computers are primary malware targets
2. **Browser Vulnerabilities** - Extensions have broad permissions
3. **Key Extraction** - Software-based key storage can be compromised
4. **User Behavior** - Users install many extensions from untrusted sources

### Mobile-First Advantages

1. **Hardware Security** - Secure enclave protects keys at hardware level
2. **Biometric Auth** - Face ID/Touch ID for every transaction
3. **Smaller Attack Surface** - iOS/Android app sandboxing
4. **User Awareness** - Mobile approval makes every action explicit
5. **Loss Prevention** - Devices can be remotely wiped

### Authentication Flow Security

1. **Challenge-Response** - Random challenge prevents replay attacks
2. **Ed25519 Signatures** - Cryptographic proof of ownership
3. **Time Limits** - Sessions expire after 5 minutes (login) or 30 days (token)
4. **Status Tracking** - "waiting" → "scanned" → "approved" state machine
5. **SSE Updates** - Real-time feedback without polling

## Session Lifecycle

**Session States:**
- `waiting` - QR code displayed, waiting for mobile scan
- `scanned` - Mobile app has retrieved session details
- `approved` - User approved and signature verified → token generated
- `rejected` - User declined login attempt
- `expired` - Session timed out (5 minutes)

**Session Token Lifecycle:**
- Generated after approval with Ed25519 signature verification
- Expires 30 days after approval
- Can be revoked at any time
- Used for subsequent authenticated API requests

## Error Responses

**404 Not Found:**
```json
{
  "error": "Session not found"
}
```

**400 Bad Request:**
```json
{
  "error": "Invalid signature"
}
```

```json
{
  "error": "Challenge mismatch"
}
```

```json
{
  "error": "Session expired"
}
```

**401 Unauthorized:**
```json
{
  "error": "Invalid or expired session token"
}
```

**500 Internal Server Error:**
```json
{
  "error": "Failed to create session"
}
```

## Related Documentation

- [Mobile Authentication Protocol](/docs/MOBILE_AUTH_PROTOCOL.md) - Detailed protocol specification
- [Transaction Signing Guide](/guides/transaction-signing/) - How Ed25519 signatures work
- [Environment Variables](/contributing/env-vars/) - Configure `IDENTITY_DB_URL` and `IDENTITY_PORT`
- [Architecture](/contributing/architecture/) - Identity service in system design
